<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bencrypt JS Test (USAG-Lib)</title>
    <script src="https://cdn.jsdelivr.net/npm/js-sha3@0.9.3/src/sha3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/argon2-browser@1.18.0/dist/argon2-bundled.min.js"></script>
    <script type="module">import {x448, ed448} from 'https://esm.sh/@noble/curves@1.4.0/ed448';window.noble = {x448, ed448};</script>
    <script src="../Bencrypt.js"></script>
    <style>
        body { font-family: monospace; padding: 20px; background-color: #f0f0f0; }
        #console { 
            background-color: #1e1e1e; 
            color: #d4d4d4; 
            padding: 15px; 
            border-radius: 5px; 
            white-space: pre-wrap; 
            min-height: 300px;
            overflow-y: auto;
        }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
        .success { color: #4caf50; }
        .info { color: #569cd6; }
        .warn { color: #cca700; }
        .error { color: #f44336; }
    </style>
</head>
<body>

    <h1>Bencrypt.js Library Test</h1>
    <p>Tests USAG-Lib Bencrypt implementation matching Python logic.</p>
    <button onclick="runTest()">(Run Test)</button>
    <br><br>
    <div id="console">Ready...</div>

    <script>
        // printer
        const consoleDiv = document.getElementById('console');
        function log(message, color = '') {
            const span = document.createElement('span');
            span.textContent = message + "\n";
            if (color) span.style.color = color;
            consoleDiv.appendChild(span);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            console.log(message);
        }

        // Uint8Array to hex string (helper)
        function formatBytes(u8) {
            if (u8.length > 100) return `[Uint8Array length=${u8.length}]`;
            try {
                return `${Array.from(u8).map(b => b.toString()).join(' ')}`;
            } catch (e) {
                return "[Error formatting bytes]";
            }
        }

        // base64 to Uint8Array
        function fromBase64(str) {
            return Uint8Array.from(atob(str), c => c.charCodeAt(0));
        }

        async function runTest() {
            InitBencrypt();
            consoleDiv.innerHTML = "";
            log("--- Start Bencrypt.js Test (Browser) ---", "white");

            let pub0 = 'MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEApCITGWNQcB8GdwWFpKW02VVYdtir1/IAbUstmwhBugo2rbdi1a/7n/hafglvwV+kxQ4jJychYjl921OhPwqlaFv/+iP8sDemmjXKW5G9QtSGFx34FVLYGewrF1ApoyvI5Zi3m7KBhrAFQyZ+6VYojnx0NJPjnCOGwSx8rb73Csi+gBoxSse5EUUwywWJ9tQkQfayFY7bVAORje7y58rrk4ASwpGNnaXgsNQffCgtBf6J4XhXm/neZP7wpDJqx6j4c5JY0OnYnCIkU66RMgEn4jHc+hg9Hfr99AWBnxjuMrAUbsaDrHrAcl5Sxhi0xzlxFvT+/PFx0BzPSt/noM0C1wIDAQAB'
            let pri0 = 'MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCkIhMZY1BwHwZ3BYWkpbTZVVh22KvX8gBtSy2bCEG6Cjatt2LVr/uf+Fp+CW/BX6TFDiMnJyFiOX3bU6E/CqVoW//6I/ywN6aaNcpbkb1C1IYXHfgVUtgZ7CsXUCmjK8jlmLebsoGGsAVDJn7pViiOfHQ0k+OcI4bBLHytvvcKyL6AGjFKx7kRRTDLBYn21CRB9rIVjttUA5GN7vLnyuuTgBLCkY2dpeCw1B98KC0F/onheFeb+d5k/vCkMmrHqPhzkljQ6dicIiRTrpEyASfiMdz6GD0d+v30BYGfGO4ysBRuxoOsesByXlLGGLTHOXEW9P788XHQHM9K3+egzQLXAgMBAAECggEAAOL2O3Lf4lsoi8gJ2sPSYEInwiyVcQsrmWuIiYfX4wtfFD0jWYgj0c9jnb6rTd4YY8AZzIJXmdI5rc+b1V1XW2Lz1QQQv1rtmXOk7i2xWgUP3FwbFPJnnGw8J1oVf34jDapvg3XJYVLeFGjG0rfWbD6b2hTaa+N9PNniqoWXjAVbWp2yJ0emN2nyFF/jhXIKJHmJZFAe4DFp/vHLykxHKOtMxsoHikjRj3KnpPy2NQzZue8jQ6UvX1zZhucR9tJb+9kVq9nLVxKVinSvaq8hLavtEh74o0ykQzxr4bT+eeX+6Jm0vON7VCH+HmeKdrACnsZ5tKd4oCA+2EXw2cPPMQKBgQDELGPJHQH0SxSjOyaXkKoSf2jvxYCQiay6Y+qT6lnL7Ag9MtOOGLARezaV8fYRBwTYdIUKCJj8jZtzTJVmg30t1qyy1jTkzwlq36cWxzToaQPYZVULuHOWMyMcUPdgLk+kslVxN7ZyhpDxdatAcnr4HphAsD20F+Dk0ZJASDU0kwKBgQDWMD3OKZOC661NsSjI7+INDIxov8aP/MBJKirj+/I9KU4cXfvzuMS/G20EvI9Bxc294Aghnp/I25Eg9NTL8AzWCJlXM4AF+fzM8yR/NlW/nfxOT07wHbvKMTQHM3bBcIKQkg3BCCIomGf0jWthXRROdWaFE3G7HksfnOS0k2pHLQKBgQC/2d24yKqpnGfRfz6tyafaMUqR+2hRcqM/Igo+oFkzamFgYH2vIQvH/OUUXa7VVjTx73pQprnffCnD5+jQedWJZ8I7n+vYvXWrVJEXYLiodlNxZSB4NuqrwNUckz5qjMANBO80q1S9ykakLfzOKWeDkoA5+2JM53FktmQ+g5+tCwKBgFnjhQywhie7oM+qOeOaSNQRIBwV388t08Tg3X8wjUj9vLpK9yIhuPA7IlWKjNSdnurAyqjRWV2CSDX8ihHMfJaWpUPjaScY8u9QW1DIDNSOCQUUY5yB3f3NCHi9MGmePi1OHleUgkFnNLl9YENMPOlwe8X9kw1keUKbJaBi/YdBAoGAWQ+zica3FnZI5oTEv44qh/S0hbjHjo3AhST+5VTOx7pitwySI8gC2u1af5fHJskBEwQKhkvOt1n7eh88aLo3b7HHB4QIur+KFrKmUvBHIa3Y2FQOTsBQj1Cj9hMTWBErqEb/+/D9n5PlH7zt5MVwZTA8HAGUpVhIR3xxUtpTiJI='
            let enc0 = 'nCFhvHbvIbAYlk8MpjVd5hmQHrbm3kVc/heznSujIV4xsofvYpxUntktOppBDHMlxoqDSS8KKOw7uC6mnzPjjNAzGY4UWBvakegqEsWVSfiGouh8sNJyMyx5dsc8dk4j2IDe8gNqE/l04cddtrfVSgRle82FJOKvSNyAfI0bJPooj1WJJIXa+LdEiP5EY8y7ccIP+2T5rTqHUHNkjzlUGZOr+6Mkj6eVgfJKhtKhw3tt7tLM/HF8NbBNPRSGO8cHEVuHMke0JLaRHc68qpE3vKT/GCxveJC5L7T5wxiX9KOwB6zr9fWaVxfTiEDGU4IdUZgyeZOAEXY9V19uFExLAw=='
            let sign0 = 'WagxpWpmGUK2vtx1Vjf1Bn67FHwdNy5co9uMV2SV9ZI6KCOYl/QWfA5oF9qIhb58lY00RVzUE+GiqQozGuAE9KIK70icBlWB1bq5azcBbR1sRDycLldT8HZPTyDdnW+pC/D0lvAWA99xVNSk5mEaJn1FKPbCAJwTrJZY5UQTF0XM8vWFUW2JQtlYLVQgcpALY6HYgOVSaXAaAEifftOurRBncn7BAudwIIv4OL5kBbXciEDlHO5aHDC3I0GG3zVhKA0BousFC2V+fiLYfH73i7K1rXIb5uhopSKhi82tRgII9rxWACwV3n3fOTSaNWvGHwZKIXvQChpRQHcBFomZcg=='
            let pub1 = '8Gjuhn7QRfAUkKEswjJXCxP+znZnp2oO8mZFHOaHs+0eHb9CnyC6JfScgAMBZB/dGY695aIHu/iY4CNGMcshZ1AxZzPs45kaCb2ZbJIAXM2VuNwdUJG3gmCYqAbRFNJSWTKZu2mFuJW/SiDLccf48YA='
            let pri1 = '7CLpb2gjTtPzLhAgEcPx2WBeuTDo1K3PGKG891IlmWzCARYbBm/pGQoG5szSqyf/0kGfYc38zOCFJM1kpZ7kKUi1jdqCUUKHXqTW9gr3ppRHQkrjlE0h2k29jrRbBxPfSgILf82roc417N3krf5JiXA='
            let enc1 = 'OENn7kZfuSIzkrtcAy+qUGM9no4Ra8Wd7HCIY66OOfBTcETHNBkHftaMdZfWTMHj3UkUbtRQpwIoCBYHE8fygKJE9oRtAhMM2cbMBmY='
            let sign1 = 'eZGi/aYQQKnR8LXtgIcaPWq+rYnq/MYpyrbJ+vjyVR83iL3eX3D3sFvTJ0SCRe5dJMoUBXxW+tAASLxmf0KHs2AeGUeo/IWLOrbwmQhxqegKmzJuOrnw7nMSv6BamvKD3/BkDKaoQiFDCq25E2nlDCIA'

            try {
                log("===== Basic Functions Test =====", "white");
                // 1-1. random
                log("random: " + formatBytes(window.random(16)), "#569cd6");

                // 1-2. sha3
                log("SHA3-256: " + formatBytes(window.sha3256(new Uint8Array(0))), "#569cd6");
                log("SHA3-512: " + formatBytes(window.sha3512(new Uint8Array(0))), "#569cd6");

                // 1-3. pbkdf2, argon2
                log("PBKDF2: " + formatBytes(await window.pbkdf2("0000", "0000000000000000")), "#569cd6");
                let t = await window.argon2Hash("0000", "0000000000000000");
                log("Argon2: " + t, "#569cd6");
                log(await window.argon2Verify(t, "0000"), "#569cd6");

                // 1-4. genkey
                log("genkey: " + formatBytes(await window.genkey("0000000000000000", "test", 16)), "#569cd6");

                log("===== Encrypting Functions Test =====", "white");
                // 2-1. AES-GCM
                const m = new AES1();
                const key = new TextEncoder().encode("0123".repeat(11));
                let plain = new TextEncoder().encode("Hello, world!".repeat(4));
                let enc = await m.enAESGCM(key, plain);
                log("en-AES-GCM: " + m.processed + ", " + formatBytes(enc), "#569cd6");
                let dec = await m.deAESGCM(key, enc);
                log("de-AES-GCM: " + m.processed + ", " + new TextDecoder().decode(dec), "#569cd6");

                // 2-2. AES-GCMx
                plain = new Uint8Array(20 * 1000000); // 20MB
                let r = new TestReader(plain);
                let w = new TestWriter();
                await m.enAESGCMx(key, r, plain.length, w);
                enc = w.getValue();
                log("en-AES-GCMx: " + m.processed + ", " +formatBytes(enc.slice(0, 16)), "#569cd6");
                r = new TestReader(enc);
                w = new TestWriter();
                await m.deAESGCMx(key, r, enc.length, w);
                dec = w.getValue();
                log("de-AES-GCMx: " + m.processed + ", " + formatBytes(dec.slice(0, 16)), "#569cd6");

                // 2-3. AES-GCMx with size 0
                plain = new Uint8Array(0);
                r = new TestReader(plain);
                w = new TestWriter();
                await m.enAESGCMx(key, r, plain.length, w);
                enc = w.getValue();
                r = new TestReader(enc);
                w = new TestWriter();
                await m.deAESGCMx(key, r, enc.length, w);
                dec = w.getValue();
                log(dec.length, "#569cd6");

                // 2-4. AES-GCMx with size 4MiB
                plain = new Uint8Array(4 * 1048576);
                r = new TestReader(plain);
                w = new TestWriter();
                await m.enAESGCMx(key, r, plain.length, w);
                enc = w.getValue();
                r = new TestReader(enc);
                w = new TestWriter();
                await m.deAESGCMx(key, r, enc.length, w);
                dec = w.getValue();
                log(dec.length / 4, "#569cd6");

                log("===== RSA Functions Test =====", "white");
                // 3-1. RSA encrypt test
                plain = new TextEncoder().encode("Hello, world!".repeat(4));
                const you0 = new RSA1();
                await you0.loadkey(fromBase64(pub0), fromBase64(pri0));
                enc = await you0.encrypt(plain);
                dec = await you0.decrypt(enc);
                log("RSA: " + new TextDecoder().decode(dec), "#569cd6");

                // 3-2. RSA sign test
                const me0 = new RSA1();
                await me0.genkey(2048);
                enc = await me0.sign(plain);
                dec = await me0.verify(plain, enc);
                log("RSA: " + dec, "#569cd6");

                // 3-3. RSA external test
                log(formatBytes( await you0.decrypt(fromBase64(enc0)) ), "#569cd6");
                log(await you0.verify("0000", fromBase64(sign0)), "#569cd6");

                log("===== ECC Functions Test =====", "white");
                // 4-1. ECC encrypt test
                plain = new TextEncoder().encode("Hello, world!".repeat(4));
                const you1 = new ECC1();
                await you1.loadkey(fromBase64(pub1), fromBase64(pri1));
                const me1 = new RSA1();
                await me1.genkey();
                enc = await me1.encrypt(plain, fromBase64(pub1));
                dec = await me1.decrypt(enc);
                log("ECC: " + new TextDecoder().decode(dec), "#569cd6");

                // 4-2. ECC sign test
                enc = await me1.sign(plain);
                dec = await me1.verify(plain, enc);
                log("ECC: " + dec, "#569cd6");

                // 4-3. ECC external test
                log(formatBytes( await you1.decrypt(fromBase64(enc1)) ), "#569cd6");
                log(await you1.verify("0000", fromBase64(sign1)), "#569cd6");

            } catch (e) {
                console.error(e);
                log(`ERROR: ${e.message}`, "#f44336");
                log(e.stack, "gray");
            }
        }
    </script>
</body>
</html>
